<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>提交审稿意见</title>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
</head>
<body>

<h2>提交审稿意见</h2>

<!-- 基本信息 -->
<div style="margin-bottom: 12px;">
    <p>
        <strong>稿件：</strong>
        <span th:text="${review.getManuScript().getTitle()}"></span>
    </p>
    <p>
        <strong>审稿任务ID：</strong>
        <span th:text="${review.getReviewId()}"></span>
    </p>
</div>

<form th:action="@{/reviewer/submitOpinion}" method="post">
    <!-- 必须带回 reviewId，用于后端定位审稿任务 -->
    <input type="hidden" name="reviewId" th:value="${review.getReviewId()}"/>

    <!-- Confidential to Editor -->
    <fieldset style="margin-bottom: 16px;">
        <legend><strong>给编辑的保密意见（Confidential to Editor）</strong></legend>
        <div style="margin: 10px 0;">
            <label for="editorId"><strong>指定编辑：</strong></label>
            <select id="editorId" name="editorId" required>
                <option value="">请选择编辑</option>
                <option th:each="editor : ${editors}"
                        th:value="${editor.getUserId()}"
                        th:text="${editor.getFullName()} + '（' + ${editor.getUserName()} + '）'">
                </option>
            </select>
        </div>

        <p style="margin: 6px 0;"><strong>打分表（1~5 分）</strong></p>

        <div style="margin-bottom: 8px;">
            <label for="scoreNovelty">创新性：</label>
            <select id="scoreNovelty" name="scoreNovelty" required>
                <option value="">请选择</option>
                <option value="1">1/5</option>
                <option value="2">2/5</option>
                <option value="3">3/5</option>
                <option value="4">4/5</option>
                <option value="5">5/5</option>
            </select>
        </div>

        <div style="margin-bottom: 8px;">
            <label for="scoreMethod">方法论：</label>
            <select id="scoreMethod" name="scoreMethod" required>
                <option value="">请选择</option>
                <option value="1">1/5</option>
                <option value="2">2/5</option>
                <option value="3">3/5</option>
                <option value="4">4/5</option>
                <option value="5">5/5</option>
            </select>
        </div>

        <div style="margin-bottom: 8px;">
            <label for="scoreQuality">整体质量：</label>
            <select id="scoreQuality" name="scoreQuality" required>
                <option value="">请选择</option>
                <option value="1">1/5</option>
                <option value="2">2/5</option>
                <option value="3">3/5</option>
                <option value="4">4/5</option>
                <option value="5">5/5</option>
            </select>
        </div>

        <div style="margin: 10px 0;">
            <label for="keyComments"><strong>关键评价：</strong></label><br/>
            <input type="hidden" id="keyComments" name="keyComments"/>

            <div id="keyCommentsEditor" style="background:#fff; border:1px solid #ccc; min-height:140px;"></div>
        </div>

        <div style="margin: 10px 0;">
            <label for="recommendation"><strong>总体建议：</strong></label>
            <select id="recommendation" name="recommendation" required>
                <option value="">请选择</option>
                <option value="REJECT">拒稿</option>
                <option value="MINOR_REVISION">小修</option>
                <option value="MAJOR_REVISION">大修</option>
                <option value="ACCEPT">接受</option>
            </select>
        </div>
    </fieldset>

    <!-- Comments to Author -->
    <fieldset style="margin-bottom: 16px;">
        <legend><strong>给作者的公开意见（Comments to Author）</strong></legend>

        <div style="margin: 10px 0;">
            <label for="commentsToAuthor"><strong>具体修改建议：</strong></label><br/>
            <input type="hidden" id="commentsToAuthor" name="commentsToAuthor"/>
            <div id="commentsToAuthorEditor" style="background:#fff; border:1px solid #ccc; min-height:180px;"></div>
        </div>
    </fieldset>

    <!-- 提交按钮 -->
    <div>
        <button type="submit">提交意见</button>
        <a th:href="@{/reviewer/reviewJobs}" style="margin-left: 10px;">返回我的审稿任务</a>
    </div>
</form>
</body>

<script>
    // 初始化两个编辑器
    const quillKey = new Quill('#keyCommentsEditor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['clean']
            ]
        }
    });

    const quillAuthor = new Quill('#commentsToAuthorEditor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['clean']
            ]
        }
    });

    // 提交时把 HTML 放回隐藏 input
    const form = document.querySelector('form');
    form.addEventListener('submit', function (e) {
        document.getElementById('keyComments').value = quillKey.root.innerHTML.trim();
        document.getElementById('commentsToAuthor').value = quillAuthor.root.innerHTML.trim();

        // 必填校验（避免空内容 <p><br></p>）
        const keyText = quillKey.getText().trim();
        const authorText = quillAuthor.getText().trim();
        if (!keyText || !authorText) {
            e.preventDefault();
            alert("请填写关键评价和给作者的修改建议（不能为空）");
        }
    });
</script>
</html>