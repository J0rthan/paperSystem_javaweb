<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="manuscriptTable(list, type)">
    <div class="table-responsive" th:if="${not #lists.isEmpty(list)}">
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th>稿件ID</th>
                <th>标题</th>
                <th>最后更新</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="p : ${list}">
                <td th:text="${'#MS-' + p.manuscriptId}"></td>
                <td>
                    <span th:if="${p.title == null or p.title == ''}" class="text-muted fst-italic">（未填写标题）</span>
                    <span th:if="${p.title != null and p.title != ''}" th:text="${p.title}" class="text-truncate d-inline-block" style="max-width: 250px;"></span>
                </td>
                <td>
                    <span th:with="uTime=${lastUpdateTimes != null ? lastUpdateTimes[p.manuscriptId] : null}">
                        <span th:if="${uTime != null}"
                            th:text="${#temporals.format(uTime, 'yyyy-MM-dd HH:mm:ss')}">
                        </span>
                        <span th:if="${uTime == null}"
                            th:text="${p.submitTime != null ? #temporals.format(p.submitTime, 'yyyy-MM-dd HH:mm:ss') : '-'}">
                        </span>
                    </span>
                </td>
                <td>
                    <span class="badge rounded-pill px-3"
                          th:classappend="${p.status == 'Accepted' or p.status == '录用'} ? 'bg-success' :
                                          (${p.status == 'Rejected' or p.status == '拒稿'} ? 'bg-danger' :
                                          (${p.status == 'Under Review' or p.status == '审稿中'} ? 'bg-info text-dark' :
                                          (${p.status == 'Need Revision' or p.status == '需要返修'} ? 'bg-primary' : 'bg-warning text-dark')))"
                          th:switch="${p.status}">
                        <span th:case="'Started Submission'">开始投稿</span>
                        <span th:case="'Incomplete Submission'">尚未提交的草稿</span>
                        <span th:case="'Pending Review'">待审查</span>
                        <span th:case="'Pending Allocation'">待初审</span>
                        <span th:case="'Pending Allocation II'">待分配</span>
                        <span th:case="'With Editor'">编辑处理</span>
                        <span th:case="'With Editor II'">编辑再处理</span>
                        <span th:case="'Under Review'">审稿中</span>
                        <span th:case="'Rejected'">拒稿</span>
                        <span th:case="'Accepted'">录用</span>
                        <span th:case="'Need Revision'">需要返修</span>
                        <span th:case="'With A Decision'">已决议</span>
                        <span th:case="*" th:text="${p.status}"></span>
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <div class="btn-group" role="group">
                            <button th:if="${(p.manuscriptPath != null and p.manuscriptPath != '') or (p.coverLetterPath != null and p.coverLetterPath != '')}"
                                    type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="bi bi-download"></i>
                            </button>
                            <ul class="dropdown-menu shadow-sm">
                                <li th:if="${p.manuscriptPath != null and p.manuscriptPath != ''}">
                                    <a class="dropdown-item small" th:href="@{/author/manuscript/download(path=${p.manuscriptPath})}">
                                        <i class="bi bi-file-earmark-text me-2"></i>主稿件
                                    </a>
                                </li>
                                <li th:if="${p.coverLetterPath != null and p.coverLetterPath != ''}">
                                    <a class="dropdown-item small" th:href="@{/author/manuscript/download(path=${p.coverLetterPath})}">
                                        <i class="bi bi-envelope me-2"></i>投稿信 (Cover Letter)
                                    </a>
                                </li>
                            </ul>
                        </div>

                        <th:block th:if="${type == 'draft'}">
                            <a th:href="@{/author/manuscript/edit(id=${p.manuscriptId})}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil-square"></i> 继续填写
                            </a>
                            <a th:href="@{/author/manuscript/delete(id=${p.manuscriptId})}"
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('警告：确定要永久删除这份稿件草稿吗？此操作不可撤销。')">
                                <i class="bi bi-trash"></i> 删除
                            </a>
                        </th:block>

                        <a th:if="${type == 'track'}"
                           th:href="@{/author/manuscript/track(id=${p.manuscriptId})}"
                           class="btn btn-sm btn-outline-info text-dark">
                            <i class="bi bi-eye"></i> 追踪状态
                        </a>

                        <a th:if="${type == 'revise'}"
                           th:href="@{/author/manuscript/revise(id=${p.manuscriptId})}"
                           class="btn btn-sm btn-success">
                            <i class="bi bi-arrow-repeat"></i> 提交修回
                        </a>

                        <a th:if="${type == 'final'}"
                           th:href="@{/author/manuscript/track(id=${p.manuscriptId})}"
                           class="btn btn-sm btn-outline-dark">
                            <i class="bi bi-file-earmark-text"></i> 查看决策
                        </a>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="text-center py-5 text-muted" th:if="${#lists.isEmpty(list)}">
        <i class="bi bi-folder2-open fs-2 d-block mb-2"></i> 暂无此类稿件
    </div>
</th:block>
</html>